@if (isValidating()) {
  <div class="min-h-screen bg-slate-100 flex items-center justify-center p-4">
    <div class="text-center">
      <div class="w-16 h-16 border-4 border-emerald-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
      <p class="text-slate-600">Validando token...</p>
    </div>
  </div>
} @else {
  <div class="min-h-screen bg-slate-100 flex items-center justify-center p-4 sm:p-6 font-sans">
    <div class="w-full max-w-md">
      <!-- Header -->
      <div class="text-center mb-8 sm:mb-10">
        <div class="inline-flex p-3 sm:p-4 bg-emerald-500 rounded-2xl shadow-lg mb-4 sm:mb-6">
          <app-icon name="Lock" size="28" class="sm:w-9 sm:h-9 text-white"></app-icon>
        </div>
        <h1 class="text-2xl sm:text-3xl font-black text-slate-900 tracking-tight mb-2">Definir Senha</h1>
        <p class="text-xs sm:text-sm text-slate-500 font-medium">Configure sua palavra-passe de acesso</p>
      </div>

      <div class="bg-white rounded-2xl sm:rounded-3xl p-6 sm:p-8 shadow-lg border border-slate-200">
        @if (!isTokenValid()) {
          <div class="space-y-4">
            <div class="mb-6 p-3 bg-rose-50 border border-rose-200 rounded-lg">
              <div class="flex items-start gap-2">
                <app-icon name="AlertTriangle" class="text-rose-500 mt-0.5 flex-shrink-0" size="16"></app-icon>
                <p class="text-rose-700 text-sm">{{ errorMessage() || 'Link inválido ou expirado.' }}</p>
              </div>
            </div>
            <app-button (onClick)="goToLogin()" class="w-full">
              Voltar para Login
            </app-button>
          </div>
        }

        @if (successMessage()) {
          <div class="space-y-4">
            <div class="p-3 bg-emerald-50 border border-emerald-200 rounded-lg">
              <p class="text-emerald-700 text-sm">{{ successMessage() }}</p>
            </div>
            <div class="text-center">
              <div class="w-16 h-16 border-4 border-emerald-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
              <p class="text-slate-500 text-sm">Redirecionando para login...</p>
            </div>
            <app-button (onClick)="goToLogin()" class="w-full">
              Ir para login agora
            </app-button>
          </div>
        }

        @if (isTokenValid() && !successMessage()) {
          <form (ngSubmit)="handleSubmit($event)" class="space-y-4 sm:space-y-6">
            @if (userInfo()) {
              <div class="p-3 bg-slate-50 rounded-lg">
                <p class="text-sm text-slate-600">
                  Bem-vindo, <span class="font-bold">{{ userInfo()?.name }}</span>
                </p>
                <p class="text-xs text-slate-500 mt-1">{{ userInfo()?.email }}</p>
              </div>
            }

            @if (errorMessage()) {
              <div class="p-3 bg-rose-50 border border-rose-200 rounded-lg">
                <p class="text-rose-700 text-sm">{{ errorMessage() }}</p>
              </div>
            }

            <!-- Nova Senha -->
            <div class="space-y-1.5">
              <label class="text-sm font-medium text-slate-700">
                Nova senha <span class="text-rose-500">*</span>
              </label>
              <div class="relative">
                <input
                  type="password"
                  [ngModel]="newPassword()"
                  (ngModelChange)="newPassword.set($event)"
                  name="password"
                  placeholder="Mínimo 6 caracteres"
                  class="w-full pl-10 pr-4 py-2.5 sm:py-3 bg-white border border-slate-300 focus:border-emerald-500 rounded-xl focus:ring-2 focus:ring-emerald-500/20 text-slate-900 outline-none transition-all text-sm"
                  [disabled]="isLoading()"
                  required
                />
                <app-icon name="Lock" class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size="18"></app-icon>
              </div>
            </div>

            <!-- Confirmar Senha -->
            <div class="space-y-1.5">
              <label class="text-sm font-medium text-slate-700">
                Confirmar senha <span class="text-rose-500">*</span>
              </label>
              <div class="relative">
                <input
                  type="password"
                  [ngModel]="confirmPassword()"
                  (ngModelChange)="confirmPassword.set($event)"
                  name="confirmPassword"
                  placeholder="Digite novamente a senha"
                  class="w-full pl-10 pr-4 py-2.5 sm:py-3 bg-white border border-slate-300 focus:border-emerald-500 rounded-xl focus:ring-2 focus:ring-emerald-500/20 text-slate-900 outline-none transition-all text-sm"
                  [disabled]="isLoading()"
                  required
                />
                <app-icon name="Lock" class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size="18"></app-icon>
              </div>
            </div>

            <!-- Requisitos da senha -->
            <div class="p-3 bg-slate-50 rounded-lg">
              <p class="text-slate-600 text-xs font-medium mb-2">Requisitos da senha:</p>
              <ul class="text-slate-500 text-xs space-y-1">
                <li class="flex items-center gap-2" [class.text-emerald-600]="passwordLengthValid">
                  <app-icon name="Check" size="12" [class.text-emerald-500]="passwordLengthValid" [class.text-slate-300]="!passwordLengthValid"></app-icon>
                  <span>Mínimo 6 caracteres</span>
                </li>
                <li class="flex items-center gap-2" [class.text-emerald-600]="passwordsMatch">
                  <app-icon name="Check" size="12" [class.text-emerald-500]="passwordsMatch" [class.text-slate-300]="!passwordsMatch"></app-icon>
                  <span>As senhas coincidem</span>
                </li>
              </ul>
            </div>

            <!-- Botão de submit -->
            <app-button
              type="submit"
              [disabled]="isLoading()"
              class="w-full py-3 sm:py-3.5"
            >
              @if (isLoading()) {
                <div class="flex items-center gap-2">
                  <div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                  <span>Definindo...</span>
                </div>
              } @else {
                <span>Definir senha</span>
              }
            </app-button>

            <!-- Link para voltar ao login -->
            <button
              type="button"
              (click)="goToLogin()"
              [disabled]="isLoading()"
              class="w-full py-2.5 text-slate-500 hover:text-slate-700 text-sm disabled:text-slate-400 transition-colors flex items-center justify-center gap-2"
            >
              <app-icon name="ArrowLeft" size="16"></app-icon>
              Voltar para Login
            </button>
          </form>
        }
      </div>

      <!-- Footer -->
      <div class="mt-6 sm:mt-8 text-center">
        <p class="text-xs text-slate-400">
          © 2026 GESTORA • Sistema de Gestão de Tarefas
        </p>
      </div>
    </div>
  </div>
}