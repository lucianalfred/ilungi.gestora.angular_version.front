<div class="bg-white dark:bg-slate-900 rounded-2xl border border-slate-200 dark:border-slate-800 overflow-hidden hover:shadow-xl transition-all group relative"
     [class.opacity-70]="isLoading_"
     [class.pointer-events-none]="isLoading_">
  
  <!-- Loading Overlay -->
  <div *ngIf="isLoading_" class="absolute inset-0 bg-white/50 dark:bg-slate-900/50 backdrop-blur-sm flex items-center justify-center z-20">
    <div class="flex flex-col items-center gap-2">
      <app-icon name="loader-2" class="w-8 h-8 animate-spin text-emerald-500"></app-icon>
      <span class="text-xs font-bold text-slate-600 dark:text-slate-400">Processando...</span>
    </div>
  </div>

  <!-- Badge de Atrasada -->
  <div *ngIf="isOverdue()" 
       class="absolute top-0 right-0 w-24 h-24 bg-rose-500/10 rounded-bl-full flex items-start justify-end p-3 z-10">
    <app-icon name="alert-triangle" class="text-rose-500" [size]="20"></app-icon>
  </div>

  <!-- Header do Card -->
  <div class="p-5 border-b border-slate-100 dark:border-slate-800">
    <div class="flex items-start justify-between gap-3">
      <div class="flex-1 min-w-0">
        <h3 class="text-lg font-black text-slate-900 dark:text-white mb-1 truncate">
          {{ task.title }}
        </h3>
        
        <!-- Status e Prioridade -->
        <div class="flex items-center gap-2 flex-wrap">
          <span class="text-xs px-2 py-1 rounded-lg font-bold whitespace-nowrap"
                [ngClass]="STATUS_COLORS[mappedStatus].badge || 'bg-slate-100 text-slate-600'">
            {{ getStatusLabel(mappedStatus) }}
          </span>
          
        </div>
      </div>

      <!-- Ações do Admin -->
      <div *ngIf="isAdmin" class="flex gap-1 flex-shrink-0">
        <button *ngIf="onEdit" 
                (click)="handleEdit()"
                class="p-2 text-slate-400 hover:text-emerald-500 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors"
                title="Editar tarefa">
          <app-icon name="pencil" [size]="16"></app-icon>
        </button>
        <button (click)="onDelete.emit()"
                class="p-2 text-slate-400 hover:text-rose-500 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors"
                title="Eliminar tarefa">
          <app-icon name="trash-2" [size]="16"></app-icon>
        </button>
      </div>
    </div>
  </div>

  <!-- Corpo do Card -->
  <div class="p-5 space-y-4">
    <!-- Descrição -->
    <p *ngIf="task.description" class="text-sm text-slate-600 dark:text-slate-400 leading-relaxed">
      {{ task.description }}
    </p>

    <!-- Datas -->
    <div class="grid grid-cols-2 gap-3 text-xs">
      <div>
        <span class="text-slate-500 dark:text-slate-500 block text-[10px] font-bold uppercase tracking-wider mb-1">
          Início
        </span>
        <div class="flex items-center gap-1 text-slate-700 dark:text-slate-300">
          <app-icon name="calendar" [size]="12" class="text-slate-400"></app-icon>
          <span class="font-medium">{{ formatDate(task.startDate) }}</span>
        </div>
      </div>
      
      <div>
        <span class="text-slate-500 dark:text-slate-500 block text-[10px] font-bold uppercase tracking-wider mb-1">
          Prazo
        </span>
        <div class="flex items-center gap-1" [class.text-rose-500]="isOverdue()">
          <app-icon name="calendar" [size]="12" [class.text-rose-500]="isOverdue()" [class.text-slate-400]="!isOverdue()"></app-icon>
          <span class="font-medium" [class.text-rose-500]="isOverdue()">{{ formatDate(task.dueDate || task.deliveryDate) }}</span>
        </div>
      </div>
    </div>

    <!-- Responsáveis -->
    <div>
      <span class="text-slate-500 dark:text-slate-500 block text-[10px] font-bold uppercase tracking-wider mb-2">
        Responsáveis
      </span>
      
      <!-- Responsável Principal -->
      <div class="flex items-center gap-2 mb-2">
        <div class="w-6 h-6 rounded-full bg-slate-200 dark:bg-slate-700 flex items-center justify-center">
          <app-icon name="user" [size]="12" class="text-slate-500"></app-icon>
        </div>
        <div class="flex-1">
          <p class="text-sm font-medium text-slate-900 dark:text-white">
            {{ respName }}
            <span class="text-xs text-slate-500 ml-1">(Responsável)</span>
          </p>
        </div>
      </div>

      <!-- Intervenientes -->
      <div *ngIf="task.intervenientes?.length" class="space-y-1">
        <div *ngFor="let intervId of task.intervenientes?.slice(0, 2)" 
             class="flex items-center gap-2">
          <div class="w-5 h-5 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center">
            <app-icon name="user" [size]="10" class="text-slate-400"></app-icon>
          </div>
          <span class="text-xs text-slate-600 dark:text-slate-400">
            {{ getUserName(intervId) }}
          </span>
        </div>
        
        <div *ngIf="task.intervenientes && task.intervenientes.length > 2" 
             class="text-xs text-slate-500 ml-7">
          +{{ task.intervenientes.length - 2 }} participantes
        </div>
      </div>
    </div>

    <!-- Comentários -->
    <div *ngIf="isTaskMember || isAdmin">
      <button (click)="toggleComments()" 
              class="flex items-center justify-between w-full text-left mb-2">
        <span class="text-slate-500 dark:text-slate-500 text-[10px] font-bold uppercase tracking-wider">
          Comentários ({{ task.comments?.length || 0 }})
        </span>
        <app-icon [name]="showComments() ? 'chevron-up' : 'chevron-down'" 
                  [size]="14" class="text-slate-400"></app-icon>
      </button>

      <div *ngIf="showComments()" class="space-y-3">
        <!-- Lista de Comentários -->
        <div *ngIf="task.comments?.length" class="space-y-2 max-h-32 overflow-y-auto">
          <div *ngFor="let comment of getRecentComments()" 
               class="bg-slate-50 dark:bg-slate-800/50 rounded-lg p-2">
            <div class="flex items-start gap-2">
              <div class="w-5 h-5 rounded-full bg-slate-200 dark:bg-slate-700 flex items-center justify-center flex-shrink-0">
                <app-icon name="user" [size]="10" class="text-slate-500"></app-icon>
              </div>
              <div class="flex-1">
                <p class="text-xs">
                  <span class="font-bold text-slate-800 dark:text-white">{{ comment.userName }}</span>
                  <span class="text-slate-600 dark:text-slate-400 ml-1">{{ comment.text }}</span>
                </p>
                <p class="text-[9px] text-slate-400 mt-0.5">
                  {{ formatDateTime(comment.timestamp) }}
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- Input para novo comentário -->
        <div class="flex gap-2">
          <input
            type="text"
            [(ngModel)]="commentText"
            (keyup.enter)="handleAddComment()"
            placeholder="Adicionar comentário..."
            class="flex-1 px-3 py-2 text-sm bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500/20"
            [disabled]="isLoading_"
          />
          <button
            (click)="handleAddComment()"
            [disabled]="!commentText.trim() || isLoading_"
            class="px-3 py-2 bg-emerald-500 text-white rounded-lg hover:bg-emerald-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
            <app-icon name="send" [size]="14"></app-icon>
          </button>
        </div>
      </div>
    </div>

    <!-- Metadados -->
    <div class="pt-3 border-t border-slate-100 dark:border-slate-800">
      <div class="flex items-center justify-between text-[9px] text-slate-400">
        <span>ID: {{ task.id.substring(0, 8) }}</span>
        <span>Criada: {{ formatDate(task.createdAt) }}</span>
      </div>
      <div *ngIf="task.updatedAt !== task.createdAt" 
           class="text-[8px] text-slate-400 mt-1">
        Atualizada: {{ formatDateTime(task.updatedAt) }}
      </div>
    </div>
  </div>

  <!-- Footer com Ações -->
  <div class="p-3 bg-slate-50 dark:bg-slate-800/50 border-t border-slate-100 dark:border-slate-800">
    <ng-container [ngSwitch]="mappedStatus !== TaskStatus.ATRASADA">
      
      <!-- Estado não atrasado -->
      <ng-container *ngSwitchCase="true">
        <ng-container *ngIf="!isClosed; else closedBlock">
          <div class="flex gap-2">
            <!-- Botão RECUAR -->
            <button *ngIf="finalCanRegress"
                    (click)="handleRegress()"
                    [disabled]="isLoading_"
                    class="flex-1 py-2 px-3 text-xs font-bold uppercase tracking-wider rounded-lg transition-all flex items-center justify-center gap-2
                           bg-slate-200 hover:bg-slate-300 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-300
                           disabled:opacity-50 disabled:cursor-not-allowed">
              <app-icon name="arrow-left" [size]="14"></app-icon>
              Recuar
            </button>

            <!-- Botão AVANÇAR -->
            <button *ngIf="finalCanAdvance"
                    (click)="handleAdvance()"
                    [disabled]="isLoading_"
                    class="flex-1 py-2 px-3 text-xs font-bold uppercase tracking-wider rounded-lg transition-all flex items-center justify-center gap-2
                           bg-emerald-500 hover:bg-emerald-600 text-white shadow-lg shadow-emerald-500/20
                           disabled:opacity-50 disabled:cursor-not-allowed">
              <span>{{ advanceButtonText }}</span>
              <app-icon name="arrow-right" [size]="14"></app-icon>
            </button>
          </div>

          <!-- Mensagens informativas -->
          <div *ngIf="isTaskMember && !finalCanAdvance && !finalCanRegress && !isClosed" 
               class="text-center text-[10px] text-slate-400 py-1">
            {{ !nextStatus && !prevStatus ? 'Sem mais ações disponíveis' : 'Não é possível alterar' }}
          </div>

          <div *ngIf="!isTaskMember && !isAdmin && !isClosed" 
               class="text-center text-[10px] text-slate-400 py-1">
            Apenas membros da tarefa podem agir
          </div>
        </ng-container>

        <!-- Estado FECHADO -->
        <ng-template #closedBlock>
          <div class="flex items-center justify-center gap-2 text-emerald-600 dark:text-emerald-400">
            <app-icon name="check-circle-2" [size]="16"></app-icon>
            <span class="text-xs font-bold uppercase tracking-wider">Tarefa Fechada</span>
          </div>
        </ng-template>
      </ng-container>

      <!-- Estado ATRASADA -->
      <div *ngSwitchCase="false" class="flex items-center justify-center gap-2 text-rose-500">
        <app-icon name="alert-triangle" [size]="16"></app-icon>
        <span class="text-xs font-bold uppercase tracking-wider">Tarefa Atrasada</span>
      </div>
    </ng-container>
  </div>
</div>