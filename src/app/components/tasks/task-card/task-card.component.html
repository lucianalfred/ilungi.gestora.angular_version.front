<div class="bg-white dark:bg-slate-900 rounded-2xl sm:rounded-[3.5rem] p-6 sm:p-10 border border-slate-100 dark:border-slate-800 shadow-sm hover:shadow-2xl transition-all group flex flex-col h-full relative overflow-hidden">
  
  <!-- Badge de Atrasada -->
  <div *ngIf="mappedStatus === TaskStatus.ATRASADA" 
       class="absolute top-0 right-0 w-24 sm:w-32 h-24 sm:h-32 bg-rose-500/10 rounded-full -mr-12 sm:-mr-16 -mt-12 sm:-mt-16 flex items-end justify-start p-4 sm:p-8">
    <app-icon name="alert-triangle" class="text-rose-500" [size]="20"></app-icon>
  </div>
  
  <!-- Cabe√ßalho com Status e A√ß√µes Admin -->
  <div class="flex justify-between items-start mb-4 sm:mb-8">
    <span class="px-3 sm:px-5 py-1.5 sm:py-2 rounded-full text-[8px] sm:text-[9px] font-black uppercase tracking-widest"
          [ngClass]="STATUS_COLORS[mappedStatus].badge || STATUS_COLORS[TaskStatus.PENDENTE].badge">
      {{ mappedStatus === TaskStatus.EM_PROGRESSO ? 'EM PROGRESSO' : mappedStatus }}
    </span>
    
    <div *ngIf="isAdmin" class="flex gap-1">
      <!-- CORRIGIDO: chamando handleEdit em vez de onEdit.emit() -->
      <button *ngIf="onEdit" (click)="handleEdit()" 
              class="p-2 text-slate-300 hover:text-emerald-500 transition-colors" 
              title="Editar">
        <app-icon name="pencil" [size]="16"></app-icon>
      </button>
      <button (click)="handleDelete()" 
              class="p-2 text-slate-300 hover:text-rose-500 transition-colors" 
              title="Eliminar">
        <app-icon name="trash-2" [size]="16"></app-icon>
      </button>
    </div>
  </div>
  
  <!-- Conte√∫do Principal -->
  <div class="flex-1 space-y-3 sm:space-y-4">
    <h3 class="text-lg sm:text-2xl font-black tracking-tight leading-tight group-hover:text-emerald-500 transition-colors">
      {{ task.title }}
    </h3>
    
    <p class="text-xs sm:text-sm text-slate-900 dark:text-slate-200 font-medium leading-relaxed">
      {{ task.description }}
    </p>
    
    <p *ngIf="respName" class="text-[10px] font-bold text-slate-800 dark:text-slate-300 uppercase">
      Respons√°vel: {{ respName }}{{ extra }}
    </p>

    <!-- Se√ß√£o de Coment√°rios (vis√≠vel apenas para membros e admin) -->
    <div *ngIf="isTaskMember || isAdmin" class="pt-3 border-t border-slate-100 dark:border-slate-800">
      
      <div class="flex items-center justify-between mb-2">
        <p class="text-xs font-bold text-slate-500">
          üí¨ Coment√°rios ({{ task.comments?.length || 0 }})
        </p>
        <button *ngIf="isAdmin && task.comments && task.comments.length > 0"
                (click)="toggleShowAllComments()"
                class="text-[9px] font-bold text-emerald-500 hover:text-emerald-600 transition-colors">
          {{ showAllComments ? 'Ocultar tudo' : 'Ver tudo' }}
        </button>
      </div>
      
      <!-- Lista de Coment√°rios -->
      <div *ngIf="showAllComments || !isAdmin" class="space-y-2 mb-3 max-h-32 overflow-y-auto">
        <div *ngFor="let comment of task.comments || []" 
             class="text-sm text-slate-600 bg-slate-50 dark:bg-slate-800 p-2 rounded-md">
          <span class="font-bold text-slate-800 dark:text-white mr-2">{{ comment.userName }}:</span>
          <span class="text-slate-600 dark:text-slate-300">{{ comment.text }}</span>
          <div class="text-[9px] text-slate-400 mt-1">
            {{ formatDateTime(comment.timestamp) }}
          </div>
        </div>
      </div>

      <!-- Input de Coment√°rio -->
      <div *ngIf="isTaskMember" class="flex gap-2">
        <input 
          [(ngModel)]="commentText"
          (keyup.enter)="handleAddComment()"
          placeholder="Adicionar coment√°rio..." 
          class="flex-1 px-3 py-1.5 rounded-lg bg-slate-50 dark:bg-slate-800 outline-none text-xs"
          [disabled]="isLoading_"
        />
        <button 
          (click)="handleAddComment()"
          [disabled]="!commentText.trim() || isLoading_"
          class="px-3 py-1.5 rounded-lg bg-emerald-500 text-white font-bold text-xs hover:bg-emerald-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
          +
        </button>
      </div>
    </div>
  </div>

  <!-- SE√á√ÉO DE BOT√ïES -->
  <div class="mt-6 sm:mt-10 pt-6 sm:pt-8 border-t border-slate-50 dark:border-slate-800">
    
    <!-- Data de prazo -->
    <div class="flex items-center gap-2 text-slate-400 mb-4">
      <app-icon name="calendar" [size]="14"></app-icon>
      <span class="text-[10px] font-black uppercase tracking-widest">
        Prazo: {{ formatDate(task.deliveryDate) }}
      </span>
    </div>

    <!-- Bot√µes de a√ß√£o -->
    <ng-container [ngSwitch]="mappedStatus !== TaskStatus.ATRASADA">
      
      <!-- Estado n√£o atrasado -->
      <ng-container *ngSwitchCase="true">
        <ng-container *ngIf="!isClosed; else closedBlock">
          <div class="flex gap-2">
            
            <!-- Bot√£o RECUAR -->
            <button *ngIf="finalCanRegress"
                    (click)="handleRegress()"
                    [disabled]="isLoading_"
                    class="flex-1 py-2.5 sm:py-3 rounded-xl sm:rounded-2xl text-[9px] font-black uppercase tracking-widest shadow-xl transition-all flex items-center justify-center gap-2 bg-slate-700 hover:bg-slate-600 text-white disabled:opacity-50">
              <span *ngIf="!isLoading_">
                <app-icon name="arrow-left" [size]="14"></app-icon>
              </span>
              <span *ngIf="isLoading_" class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></span>
              Recuar
            </button>

            <!-- Bot√£o AVAN√áAR -->
            <button *ngIf="finalCanAdvance"
                    (click)="handleAdvance()"
                    [disabled]="isLoading_"
                    class="flex-1 py-2.5 sm:py-3 rounded-xl sm:rounded-2xl text-[9px] font-black uppercase tracking-widest shadow-xl transition-all flex items-center justify-center gap-2"
                    [ngClass]="isFinished ? 'bg-emerald-500 text-white shadow-emerald-500/20' : 'bg-slate-900 dark:bg-slate-700 text-white hover:bg-emerald-500'">
              <span *ngIf="!isLoading_">
                <app-icon *ngIf="isFinished && isAdmin" name="check" [size]="14"></app-icon>
                <app-icon *ngIf="isFinished && !isAdmin" name="shield-check" [size]="14"></app-icon>
                <app-icon *ngIf="!isFinished" name="arrow-right" [size]="14"></app-icon>
              </span>
              <span *ngIf="isLoading_" class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></span>
              {{ advanceButtonText }}
            </button>

            <!-- Mensagens informativas -->
            <div *ngIf="isTaskMember && !finalCanAdvance && !finalCanRegress && !isClosed" 
                 class="w-full text-center text-[10px] text-slate-400 py-2">
              {{ !nextStatus && !prevStatus ? 'Sem mais a√ß√µes dispon√≠veis' : 'N√£o √© poss√≠vel alterar' }}
            </div>

            <div *ngIf="!isTaskMember && !isAdmin && !isClosed" 
                 class="w-full text-center text-[10px] text-slate-400 py-2">
              Apenas membros da tarefa podem agir
            </div>
          </div>
        </ng-container>

        <!-- Estado FECHADO -->
        <ng-template #closedBlock>
          <div class="text-emerald-500 flex items-center gap-1 font-black text-[9px] uppercase tracking-widest">
            <app-icon name="check-circle-2" [size]="16"></app-icon>
            Fechada
          </div>
        </ng-template>
      </ng-container>

      <!-- Estado ATRASADA -->
      <div *ngSwitchCase="false" class="text-rose-500 flex items-center gap-1 font-black text-[9px] uppercase tracking-widest">
        <app-icon name="alert-triangle" [size]="16"></app-icon>
        Em atraso
      </div>
    </ng-container>
  </div>
</div>